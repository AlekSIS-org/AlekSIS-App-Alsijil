{# -*- engine:django -*- #}

{% extends "core/base.html" %}
{% load material_form i18n week_helpers static %}

{% block browser_title %}{% blocktrans %}Week view{% endblocktrans %}{% endblock %}

{% block extra_head %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'css/alsijil/alsijil.css' %}"/>
{% endblock %}

{% block content %}
  <div class="row">
    {% if group %}
      <div class="col s12 m2 push-m10 l1 push-l11">
        <a class="col s12 btn waves-effect waves-light right" href="{% url 'full_register_group' group.id %}">
          <i class="material-icons center">print</i>
        </a>
      </div>
    {% endif %}
    <div class="col s12 m10 pull-m2 l11 pull-l1">
      <form method="post" action="">
        {% csrf_token %}
        {% form form=select_form %}{% endform %}
        <button type="submit" class="btn waves-effect waves-light">
          {% blocktrans %}Select{% endblocktrans %}
        </button>
      </form>
    </div>
  </div>

  <h4>{% blocktrans with el=el week=week.week %}CW {{ week }}: {{ instance }}{% endblocktrans %} </h4>

  {% if lesson_periods %}
    <div class="row">
      <div class="col s7">
        {% regroup lesson_periods by period.get_weekday_display as periods_by_day %}
        {% for weekday, periods in periods_by_day %}
          <div class="card">
            <div class="card-content">
              <span class="card-title">
                {{ weekday }}
              </span>
              <table class="striped responsive-table datatable">
                <thead>
                <tr>
                  <th>{% blocktrans %}Period{% endblocktrans %}</th>
                  <th>{% blocktrans %}Subject{% endblocktrans %}</th>
                  <th>{% blocktrans %}Teachers{% endblocktrans %}</th>
                </tr>
                </thead>
                <tbody>
                {% for period in periods %}
                  <tr class="
                      {% if period.has_documentation %}
                        success
                      {% else %}
                        {% weekday_to_date week period.period.weekday as current_date %}
                        {% today as today %}
                        {% if current_date < today %}
                          error
                        {% else %}
                          {% if period.get_substitution %}
                            warning
                            {% if period.get_substitution.cancelled %}
                              alsijil-lesson-cancelled
                            {% endif %}
                          {% endif %}
                        {% endif %}
                      {% endif %}
                    ">
                    <td>{{ period.period.period }}</td>
                    <td>
                      <a href="{% url 'lesson_by_week_and_period' week.year week.week period.id %}">
                        {{ period.get_subject.name }}
                      </a>
                    </td>
                    <td>{{ period.get_teacher_names }}</td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        {% endfor %}
      </div>
      <div class="col s5">
        <div class="card">
          <div class="card-content">
            <span class="card-title">
              {% blocktrans %}Personal notes{% endblocktrans %}
            </span>
            {% for person in persons %}
              <h5 class="card-title">{{ person.full_name }}</h5>
              <p class="card-text">
                {% trans "Absent" %}: {{ person.absences_count }}
                ({{ person.unexcused_count }} {% trans "unexcused" %})
              </p>
              <p class="card-text">
                {% trans "Summed up tardiness" %}: {{ person.tardiness_sum }}'
              </p>
              {% for note in person.personal_notes|only_week:week %}
                {% if note.remarks %}
                  <blockquote>
                    {{ note.remarks }}
                    {% weekday_to_date week note.lesson_period.period.weekday as note_date %}
                    <em class="right">
                      <a href="{% url 'lesson_by_week_and_period' week.year week.week note.lesson_period.id %}">
                        {{ note_date }}, {{ note.lesson_period.get_subject.name }}
                      </a>
                    </em>
                  </blockquote>
                {% endif %}
              {% endfor %}
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  {% else %}
    <div class="card red darken-1">
      <div class="card-content white-text">
        <span class="card-title">
          {% blocktrans %}No group selected{% endblocktrans %}
        </span>
        <p>
          {% blocktrans %}
            There are no lessons for the selected group, teacher or time.
          {% endblocktrans %}
        </p>
      </div>
    </div>
  {% endif %}

  <script>
    $(document).ready(function () {
      $("#id_group").change(function () {
        $("#id_teacher").val("").formSelect();
      });
      $("#id_teacher").change(function () {
        $("#id_group").val("").formSelect();
      });
    });

  </script>
{% endblock %}
