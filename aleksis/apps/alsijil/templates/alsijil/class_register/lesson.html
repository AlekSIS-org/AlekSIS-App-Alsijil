{# -*- engine:django -*- #}
{% extends "core/base.html" %}
{% load week_helpers material_form_internal material_form i18n static rules time_helpers %}

{% block browser_title %}{% blocktrans %}Lesson{% endblocktrans %}{% endblock %}

{% block extra_head %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'css/alsijil/lesson.css' %}"/>
{% endblock %}

{% block page_title %}
  {% with lesson_period.get_lesson_documentation as lesson_doc %}
    <a href="{% url "week_view_by_week" lesson_doc.year lesson_doc.week "group" lesson_period.lesson.groups.all.0.pk %}"
       class="btn-flat primary-color-text waves-light waves-effect">
      <i class="material-icons left">chevron_left</i> {% trans "Back" %}
    </a>
  {% endwith %}
  {{ day }}, {% blocktrans with period=lesson_period.period.period %}{{ period }}. period{% endblocktrans %} –

  {% for group in lesson_period.get_groups.all %}
    <span>{{ group.name }}</span>,
  {% endfor %}

  {{ lesson_period.get_subject.name }},

  {% for teacher in lesson_period.get_teachers.all %}
    {{ teacher.short_name }}
  {% endfor %}

  <span class="right">
    {% include "alsijil/partials/lesson_status_icon.html" with period=lesson_period css_class="medium" %}
  </span>
{% endblock %}

{% block content %}
  {% has_perm "alsijil.view_lessondocumentation" user lesson_period as can_view_lesson_documentation %}
  {% has_perm "alsijil.edit_lessondocumentation" user lesson_period as can_edit_lesson_documentation %}
  {% has_perm "alsijil.edit_lesson_personalnote" user lesson_period as can_edit_lesson_personalnote %}

  <div class="row">
    <div class="col s12">
      <a class="btn-flat left waves-effect waves-light"
         href="{% url "lesson_by_week_and_period" prev_lesson.week.year prev_lesson.week.week prev_lesson.id %}">
        <i class="material-icons left">arrow_back</i>
        {% trans "Previous lesson" %}
      </a>

      <a class="btn-flat right waves-effect waves-light"
         href="{% url "lesson_by_week_and_period" next_lesson.week.year next_lesson.week.week next_lesson.id %}">
        <i class="material-icons right">arrow_forward</i>
        {% trans "Next lesson" %}
      </a>
    </div>
  </div>

  <form method="post">
    {% if can_edit_lesson_documentation or can_edit_lesson_personalnote %}
      <p>{% include "core/partials/save_button.html" %}</p>
    {% endif %}

    {% csrf_token %}

    <div class="row">
      <div class="col s12">
        <ul class="tabs">
          <li class="tab">
            <a href="#lesson-documentation">{% trans "Lesson documentation" %}</a>
          </li>
          {% if not lesson_period.get_substitution.cancelled or not request.site.preferences.alsijil__block_personal_notes_for_cancelled %}
            <li class="tab">
              <a href="#personal-notes">{% trans "Personal notes" %}</a>
            </li>
          {% endif %}
          {% has_perm "alsijil.view_lessondocumentation" user lesson_period.prev as can_view_prev_lesson_documentation %}
          {% if lesson_period.prev.get_lesson_documentation and can_view_prev_lesson_documentation %}
            <li class="tab">
              <a href="#previous-lesson">{% trans "Previous lesson" %}</a>
            </li>
          {% endif %}
          <li class="tab">
            <a href="#version-history">{% trans "Change history" %}</a>
          </li>
        </ul>
      </div>

      <div class="col s12" id="lesson-documentation">
        <div class="card">
          <div class="card-content">
          <span class="card-title">
            {% blocktrans %}Lesson documentation{% endblocktrans %}
          </span>

            {% if can_edit_lesson_documentation %}
              {% form form=lesson_documentation_form %}{% endform %}
            {% elif can_view_lesson_documentation %}
              <table>
                <tr>
                  <th>
                    {% trans "Lesson topic" %}
                  </th>
                  <td>
                    {{ lesson_documentation.topic }}
                  </td>
                </tr>
                <tr>
                  <th>
                    {% trans "Homework" %}
                  </th>
                  <td>
                    {{ lesson_documentation.homework }}
                  </td>
                </tr>
                <tr>
                  <th>
                    {% trans "Group note" %}
                  </th>
                  <td>
                    {{ lesson_documentation.group_note }}
                  </td>
                </tr>
              </table>
            {% endif %}
          </div>
        </div>
      </div>

      {% with prev_lesson=lesson_period.prev prev_doc=prev_lesson.get_lesson_documentation %}
        {% with absences=prev_lesson.get_absences tardinesses=prev_lesson.get_tardinesses extra_marks=prev_lesson.get_extra_marks %}
          {% has_perm "alsijil.view_lessondocumentation" user prev_lesson as can_view_prev_lesson_documentation %}
          {% if prev_doc and can_view_prev_lesson_documentation %}
            {% weekday_to_date prev_lesson.week prev_lesson.period.weekday as prev_date %}
            <div class="col s12" id="previous-lesson">
              <div class="card">
                <div class="card-content">
                  <span class="card-title">
                    {% blocktrans %}Overview: Previous lesson{% endblocktrans %} ({{ prev_date }},
                    {% blocktrans with period=prev_lesson.period.period %}{{ period }}. period{% endblocktrans %})
                  </span>

                  <table>
                    {% if prev_doc.topic %}
                      <tr>
                        <th class="collection-item">{% trans "Lesson topic of previous lesson:" %}</th>
                        <td>{{ prev_doc.topic }}</td>
                      </tr>
                    {% endif %}

                    {% if prev_doc.homework %}
                      <tr>
                        <th class="collection-item">{% trans "Homework for this lesson:" %}</th>
                        <td>{{ prev_doc.homework }}</td>
                      </tr>
                    {% endif %}

                    {% if prev_doc.group_note %}
                      <tr>
                        <th class="collection-item">{% trans "Group notes for previous lesson:" %}</th>
                        <td>{{ prev_doc.group_note }}</td>
                      </tr>
                    {% endif %}

                    {% if absences %}
                      <tr>
                        <th>{% trans "Absent persons:" %}</th>
                        <td>{% include "alsijil/partials/absences.html" with notes=absences %}</td>
                      </tr>
                    {% endif %}

                    {% if tardinesses %}
                      <tr>
                        <th>{% trans "Late persons:" %}</th>
                        <td>{% include "alsijil/partials/tardinesses.html" with notes=tardinesses %}</td>
                      </tr>
                    {% endif %}

                    {% for extra_mark, notes in extra_marks.items %}
                      <tr>
                        <th>{{ extra_mark.name }}</th>
                        <td>
                          {% for note in notes %}
                            {% has_perm "alsijil.view_personalnote" user note as can_view_personalnote %}
                            {% if can_view_personalnote %}
                              <span>{{ note.person }}{% if not forloop.last %},{% endif %}</span>
                            {% endif %}
                          {% endfor %}
                        </td>
                      </tr>
                    {% endfor %}

                  </table>
                </div>
              </div>
            </div>
          {% endif %}
        {% endwith %}
      {% endwith %}

      {% if not lesson_period.get_substitution.cancelled or not request.site.preferences.alsijil__block_personal_notes_for_cancelled %}
        <div class="col s12" id="personal-notes">
          <div class="card">
            <div class="card-content">
              <span class="card-title">
                {% blocktrans %}Personal notes{% endblocktrans %}
              </span>
              {% if can_edit_lesson_personalnote %}
                {% form form=personal_note_formset.management_form %}{% endform %}
              {% endif %}

              <table class="striped responsive-table alsijil-table">
                <thead>
                <tr>
                  <th>{% blocktrans %}Person{% endblocktrans %}</th>
                  <th>{% blocktrans %}Absent{% endblocktrans %}</th>
                  <th>{% blocktrans %}Tardiness{% endblocktrans %}</th>
                  <th>{% blocktrans %}Excused{% endblocktrans %}</th>
                  <th>{% blocktrans %}Excuse type{% endblocktrans %}</th>
                  <th>{% blocktrans %}Extra marks{% endblocktrans %}</th>
                  <th>{% blocktrans %}Remarks{% endblocktrans %}</th>
                </tr>
                </thead>
                <tbody>
                {% for form in personal_note_formset %}
                  {% if can_edit_lesson_personalnote %}
                    <tr>
                      {{ form.id }}
                      <td>{{ form.person_name }}{{ form.person_name.value }}</td>
                      <td class="center-align">
                        <label>
                          {{ form.absent }}
                          <span></span>
                        </label>
                      </td>
                      <td>
                        <div class="input-field">
                          {{ form.late }}
                          <label for="{{ form.absent.id_for_label }}">
                            {% trans "Tardiness (in m)" %}
                          </label>
                        </div>
                      </td>
                      <td class="center-align">
                        <label>
                          {{ form.excused }}
                          <span></span>
                        </label>
                      </td>
                      <td>
                        <div class="input-field">
                          {{ form.excuse_type }}
                          <label for="{{ form.excuse_type.id_for_label }}">
                            {% trans "Excuse type" %}
                          </label>
                        </div>
                      </td>
                      <td>
                        {% for group, items in form.extra_marks|select_options %}
                          {% for choice, value, selected in items %}
                            <label class="{% if selected %} active{% endif %} alsijil-check-box">
                              <input type="checkbox"
                                     {% if value == None or value == '' %}disabled{% else %}value="{{ value }}"{% endif %}
                                      {% if selected %} checked="checked"{% endif %}
                                     name="{{ form.extra_marks.html_name }}">
                              <span>{{ choice }}</span>
                            </label>
                          {% endfor %}
                        {% endfor %}
                      </td>
                      <td>
                        <div class="input-field">
                          {{ form.remarks }}
                          <label for="{{ form.absent.id_for_label }}">
                            {% trans "Remarks" %}
                          </label>
                        </div>
                      </td>
                    </tr>
                  {% else %}
                    <tr>
                      <td>{{ form.person_name.value }}</td>
                      <td><i class="material-icons center">{{ form.absent.value|yesno:"check,clear" }}</i></td>
                      <td>
                        <i class="material-icons center">{{ form.late.value|yesno:"check,clear" }}</i>
                        <span class="alsijil-tardiness-text">
                            {% if form.late.value %}{{ form.late.value|to_time|time:"i\m" }}{% endif %}
                          </span>
                      </td>
                      <td><i class="material-icons center">{{ form.excused.value|yesno:"check,clear" }}</i></td>
                      <td>{% firstof form.excuse_type.value "–" %}</td>
                      <td>
                        {% for extra_mark in form.extra_marks.value %}
                          {{ extra_mark }}{% if not forloop.last %},{% endif %}
                        {% empty %}
                          –
                        {% endfor %}
                      </td>
                      <td>{% firstof form.remarks.value "–" %}</td>
                    </tr>
                  {% endif %}
                {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      {% endif %}

      {% if can_view_lesson_documentation %}
        <div class="col s12" id="version-history">
          <div class="card">
            <div class="card-content">
          <span class="card-title">
            {% blocktrans %}Change history{% endblocktrans %}
          </span>
              {% include 'core/partials/crud_events.html' with obj=lesson_documentation %}
            </div>
          </div>
        </div>
      {% endif %}
    </div>

    {% if can_edit_lesson_documentation or can_edit_lesson_personalnote %}
      <p>{% include "core/partials/save_button.html" %}</p>
    {% endif %}
  </form>
{% endblock %}
