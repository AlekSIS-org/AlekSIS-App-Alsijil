{# -*- engine:django -*- #}

{% extends "core/base.html" %}
{% load material_form i18n week_helpers static data_helpers %}

{% block browser_title %}{% blocktrans %}Week view{% endblocktrans %}{% endblock %}

{% block extra_head %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'css/alsijil/alsijil.css' %}"/>
{% endblock %}

{% block content %}
  <script type="text/javascript" src="{% static "js/helper.js" %}"></script>
  {{ week_select|json_script:"week_select" }}
  <script type="text/javascript" src="{% static "js/chronos/week_select.js" %}"></script>
  <div class="row">
    {% if group %}
      <div class="col s12 m2 push-m10 l1 push-l11">
        <a class="col s12 btn waves-effect waves-light right" href="{% url 'full_register_group' group.id %}">
          <i class="material-icons center">print</i>
        </a>
      </div>
    {% endif %}
    <div class="col s12 {% if group %}m10 pull-m2 l11 pull-l1 {% endif %}">
      <form method="post" action="">
        {% csrf_token %}
        {% form form=select_form %}{% endform %}
        <button type="submit" class="btn waves-effect waves-light">
          {% blocktrans %}Select{% endblocktrans %}
        </button>
      </form>
    </div>
  </div>


  <div class="row">
    <h4 class="col s12 m6">{% blocktrans with el=el week=week.week %}CW {{ week }}: {{ instance }}{% endblocktrans %} </h4>
    {% include "chronos/partials/week_select.html" with wanted_week=week %}
  </div>

  {% if lesson_periods %}
    <div class="row">
      <div class="col s12 m7">
        {% regroup lesson_periods by period.get_weekday_display as periods_by_day %}
        {% for weekday, periods in periods_by_day %}
          <div class="card">
            <div class="card-content">
              {% weekday_to_date week periods.0.period.weekday as current_date %}
              <span class="card-title">
                {{ weekday }}, {{ current_date }}
              </span>
              <table class="striped datatable">
                <thead>
                <tr>
                  <th></th>
                  <th>{% blocktrans %}Period{% endblocktrans %}</th>
                  {% if not group %}
                    <th>{% blocktrans %}Groups{% endblocktrans %}</th>
                  {% endif %}
                  <th>{% blocktrans %}Subject{% endblocktrans %}</th>
                  <th>{% blocktrans %}Teachers{% endblocktrans %}</th>
                  <th>{% blocktrans %}Lesson topic{% endblocktrans %}</th>
                </tr>
                </thead>
                <tbody>
                {% for period in periods %}
                  {% has_perm "alsijil.view_lessondocumentation" user period as can_view_lesson_documentation %}
                  {% if can_view_lesson_documentation %}
                    <tr>
                      <td class="center-align">
                        {% include "alsijil/partials/lesson_status_icon.html" with period=period %}
                      </td>
                      <td class="tr-link">
                        <a class="tr-link" href="{% url 'lesson_by_week_and_period' week.year week.week period.id %}">
                          {{ period.period.period }}.
                        </a>
                      </td>
                      {% if not group %}
                        <td>
                          <a class="tr-link" href="{% url 'lesson_by_week_and_period' week.year week.week period.id %}">
                            {{ period.lesson.group_names }}
                          </a>
                        </td>
                      {% endif %}
                      <td>
                        <a class="tr-link" href="{% url 'lesson_by_week_and_period' week.year week.week period.id %}">
                          {{ period.get_subject.name }}
                        </a>
                      </td>
                      <td>
                        <a class="tr-link" href="{% url 'lesson_by_week_and_period' week.year week.week period.id %}">
                          {{ period.get_teacher_names }}
                        </a>
                      </td>
                      <td>
                        <a class="tr-link" href="{% url 'lesson_by_week_and_period' week.year week.week period.id %}">
                          {{ period.get_lesson_documentation.topic }}
                        </a>
                      </td>
                    </tr>
                  {% endif %}
                {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        {% endfor %}
      </div>
      <div class="col s12 m5">
        <div class="card">
          <div class="card-content">
            <span class="card-title">
              {% blocktrans %}Personal notes{% endblocktrans %}
            </span>
            {% for person in persons %}
              <h5 class="card-title">{{ person.person.full_name }}</h5>
              <p class="card-text">
                {% trans "Absent" %}: {{ person.person.absences_count }}
                ({{ person.person.unexcused_count }} {% trans "unexcused" %})
              </p>
              <p class="card-text">
                {% trans "Summed up tardiness" %}: {{ person.person.tardiness_sum }}'
              </p>
              {% for extra_mark in extra_marks %}
                <p class="card-text">
                  {{ extra_mark.name }}: {{ person.person|get_dict:extra_mark.count_label }}
                </p>
              {% endfor %}
              {% for note in person.personal_notes %}
                {% if note.remarks %}
                  <blockquote>
                    {{ note.remarks }}
                    {% weekday_to_date week note.lesson_period.period.weekday as note_date %}
                    <em class="right">
                      <a href="{% url 'lesson_by_week_and_period' week.year week.week note.lesson_period.id %}">
                        {{ note_date }}, {{ note.lesson_period.get_subject.name }}
                      </a>
                    </em>
                  </blockquote>
                {% endif %}
              {% endfor %}
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  {% else %}
    <div class="card red darken-1">
      <div class="card-content white-text">
        <span class="card-title">
          {% blocktrans %}No lessons available{% endblocktrans %}
        </span>
        <p>
          {% blocktrans %}
            There are no lessons for the selected group or teacher in this week.
          {% endblocktrans %}
        </p>
      </div>
    </div>
  {% endif %}

  <script>
    $(document).ready(function () {
      $("#id_group").change(function () {
        $("#id_teacher").val("").formSelect();
      });
      $("#id_teacher").change(function () {
        $("#id_group").val("").formSelect();
      });
    });

  </script>
{% endblock %}
